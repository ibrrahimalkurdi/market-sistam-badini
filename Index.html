‏<!DOCTYPE html>
‏<html lang="ku" dir="rtl">
‏<head>
‏    <meta charset="UTF-8">
‏    <meta name="viewport" content="width=device-width, initial-scale=1.0">
‏    <title>سیستەمێ مارکێتێ</title>
    
‏    <!-- Ji bo ئایکۆنان -->
‏    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
‏    <style>
‏        :root {
‏            --primary-color: #005f73; --secondary-color: #0a9396; --accent-color: #94d2bd;
‏            --danger-color: #ae2012; --success-color: #2a9d8f; --background-color: #f8f9fa;
‏            --card-bg: #ffffff; --text-color: #2b2d42; --border-radius: 12px;
‏            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
‏        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        
‏        body { font-family: 'Vazirmatn', -apple-system, sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); line-height: 1.7; -webkit-tap-highlight-color: transparent; }
        
‏        /* --- Beşê Lۆگینکرنێ --- */
‏        #auth-view { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
‏        .auth-container { width: 100%; max-width: 400px; background-color: var(--card-bg); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
‏        .auth-container h2 { text-align: center; margin-top: 0; margin-bottom: 2rem; color: var(--primary-color); }
‏        .form-group { margin-bottom: 1.5rem; }
‏        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
‏        .form-group input { width: 100%; padding: 0.9rem; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1rem; transition: all 0.2s; }
‏        .form-group input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(0, 95, 115, 0.2); }
‏        .btn { background-color: var(--secondary-color); color: white; border: none; padding: 0.9rem 1.8rem; font-size: 1.1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s; margin: 0 0.5rem; font-weight: bold; width: 100%; }
‏        .btn.btn-danger { background-color: var(--danger-color); }
‏        .auth-toggle { text-align: center; margin-top: 1.5rem; color: var(--primary-color); cursor: pointer; font-weight: bold; }

‏        /* --- Serekî App --- */
‏        #app-container { display: none; }
‏        header { background-color: var(--primary-color); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
‏        .header-left { display: flex; align-items: center; gap: 1rem; }
‏        #market-name-display { font-size: 1.1rem; font-weight: bold; }
‏        #logout-btn { background: var(--danger-color); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; line-height: 1; }
‏        .tabs { display: flex; gap: 0.5rem; }
‏        .tab-btn { background-color: var(--secondary-color); color: white; border: none; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s; }
‏        .tab-btn.active { background-color: white; color: var(--primary-color); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
‏        main { padding: 1.5rem; max-width: 1200px; margin: auto; }
‏        .view { display: none; }
‏        .view.active { display: block; animation: fadeIn 0.5s ease; }
‏        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
‏        h2 { border-bottom: 3px solid var(--secondary-color); padding-bottom: 0.5rem; margin-bottom: 2rem; color: var(--primary-color); }
        
‏        /* --- Beşê Skanerê --- */
‏        #scanner-view { text-align: center; }
‏        #interactive { position: relative; width: 100%; max-width: 600px; margin: 1rem auto; border-radius: var(--border-radius); box-shadow: var(--box-shadow); overflow: hidden; min-height: 300px; background-color: #333; }
‏        #interactive video, #interactive canvas { width: 100%; height: auto; }
‏        #interactive canvas.drawingBuffer { position: absolute; top: 0; left: 0; }
‏        .scanner-controls { margin: 1.5rem 0; display: flex; justify-content: center; gap: 1rem; }
‏        .scanner-controls .btn { width: auto; }
‏        #scan-status { font-weight: bold; color: var(--primary-color); min-height: 24px; margin-top: 1rem; }
‏        #result-container { background-color: var(--card-bg); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin: 1.5rem auto; max-width: 600px; text-align: right; border-right: 7px solid var(--accent-color); opacity: 0; visibility: hidden; transition: all 0.4s ease; transform: scale(0.95); }
‏        #result-container.visible { opacity: 1; visibility: visible; transform: scale(1); }
‏        #result-container.not-found { border-right-color: var(--danger-color); }

‏        /* --- Beşê Rêveberîyê --- */
‏        .admin-layout { display: grid; grid-template-columns: 1fr; gap: 2rem; } @media (min-width: 992px) { .admin-layout { grid-template-columns: 400px 1fr; } }
‏        .admin-section { background-color: var(--card-bg); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
‏        .input-with-icon { position: relative; }
‏        .input-with-icon input { padding-left: 3.2rem !important; }
‏        .input-with-icon .icon-btn { position: absolute; left: 0; top: 0; bottom: 0; width: 3rem; border: none; background: var(--accent-color); color: var(--primary-color); font-size: 1.5rem; border-radius: 0 8px 8px 0; cursor: pointer; }
‏        #product-list-container table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
‏        #product-list-container th, #product-list-container td { padding: 1rem; border-bottom: 1px solid #ddd; text-align: right; vertical-align: middle; }
‏        .delete-btn { background: transparent; color: var(--danger-color); border: none; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; }
‏        .delete-btn:hover { color: #7a160c; transform: scale(1.2); }
        
‏        /* --- Pencereya Skanerî (Modal) --- */
‏        #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; animation: fadeInModal 0.3s; }
‏        .modal-content { background: white; padding: 1.5rem; border-radius: var(--border-radius); width: 90%; max-width: 500px; text-align: center; }
‏        #admin-scanner-viewport { position: relative; border-radius: var(--border-radius); overflow: hidden; min-height: 250px; background: #333; }
‏        #admin-scanner-viewport video, #admin-scanner-viewport canvas { max-width: 100%; }
‏        #admin-scan-status { margin-top: 1rem; font-weight: bold; min-height: 24px; }
‏        .modal-content .btn-danger { margin-top: 1.5rem; width: auto; }
‏        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

‏        /* --- Peyama Toast --- */
‏        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: bottom 0.5s ease; z-index: 3000; font-weight: bold; }
‏        #toast.danger { background-color: var(--danger-color); }
‏        #toast.show { bottom: 30px; }
‏    </style>
‏</head>
‏<body>

‏    <section id="auth-view">
‏        <div class="auth-container">
‏            <form id="login-form">
‏                <h2>لۆگینکرن بۆ سیستەمی</h2>
‏                <div class="form-group"><label for="login-email">ئیمێل:</label><input type="email" id="login-email" required></div>
‏                <div class="form-group"><label for="login-password">ژمارا نهێنی:</label><input type="password" id="login-password" required></div>
‏                <button type="submit" class="btn">لۆگینکرن</button>
‏                <p class="auth-toggle" id="show-register">حسابا تە نینە؟ ئێکێ نوی چێکە</p>
‏            </form>
‏            <form id="register-form" style="display:none;">
‏                <h2>چێکرنا حسابەکا نوی</h2>
‏                <div class="form-group"><label for="register-market-name">ناڤێ مارکێتێ:</label><input type="text" id="register-market-name" required></div>
‏                <div class="form-group"><label for="register-email">ئیمێل:</label><input type="email" id="register-email" required></div>
‏                <div class="form-group"><label for="register-password">ژمارا نهێنی:</label><input type="password" id="register-password" required></div>
‏                <button type="submit" class="btn">تۆمارکرن</button>
‏                <p class="auth-toggle" id="show-login">حسابا تە هەیە؟ لۆگین بکە</p>
‏            </form>
‏        </div>
‏    </section>

‏    <div id="app-container">
‏        <header>
‏            <nav class="tabs">
‏                <button class="tab-btn active" data-view="scanner-view">سکانەر</button>
‏                <button class="tab-btn" data-view="admin-view">رێڤەبەری</button>
‏            </nav>
‏            <div class="header-left">
‏                <span id="market-name-display"></span>
‏                <button id="logout-btn" title="ژ سیستەمی دەرکەڤە"><i class="fa-solid fa-right-from-bracket"></i></button>
‏            </div>
‏        </header>

‏        <main>
‏            <section id="scanner-view" class="view active">
‏                <h2>خواندنا بارکۆدێ</h2>
‏                <div id="interactive"></div>
‏                <p id="scan-status"></p>
‏                <div class="scanner-controls">
‏                    <button id="start-scanner-btn" class="btn">دەستپێکرن</button>
‏                    <button id="stop-scanner-btn" class="btn btn-danger" disabled>راوەستاندن</button>
‏                </div>
‏                <div id="result-container">
‏                    <p><strong>ناڤ:</strong> <span id="product-name-result"></span></p>
‏                    <p><strong>بها:</strong> <span id="product-price-result" style="font-size: 2rem; color: var(--success-color); font-weight: bold;"></span></p>
‏                </div>
‏            </section>

‏            <section id="admin-view" class="view">
‏                <div class="admin-layout">
‏                    <div class="admin-section">
‏                        <h2>زێدەکرنا بەرهەمەکێ نوی</h2>
‏                        <form id="add-product-form">
‏                            <div class="form-group">
‏                                <label for="barcode">ژمارا بارکۆدی:</label>
‏                                <div class="input-with-icon">
‏                                    <input type="number" id="barcode" required placeholder="بارکۆدی بنڤیسە یان سکان بکە">
‏                                    <button type="button" class="icon-btn" id="scan-for-admin-btn" title="سکانکرن"><i class="fa-solid fa-barcode"></i></button>
‏                                </div>
‏                            </div>
‏                            <div class="form-group"><label for="product-name">ناڤێ بەرهەمی:</label><input type="text" id="product-name" required></div>
‏                            <div class="form-group"><label for="product-price">بها (ب دینارێ ئیراقی):</label><input type="number" id="product-price" required></div>
‏                            <button type="submit" class="btn">تۆمارکرن</button>
‏                        </form>
‏                    </div>
‏                    <div class="admin-section">
‏                        <h2>لیستا بەرهەمان</h2>
‏                        <div id="product-list-container"></div>
‏                    </div>
‏                </div>
‏            </section>
‏        </main>
‏    </div>
    
‏    <div id="scanner-modal">
‏        <div class="modal-content">
‏            <h3>سکانکرنا بارکۆدی</h3>
‏            <div id="admin-scanner-viewport"></div>
‏            <p id="admin-scan-status"></p>
‏            <button id="close-modal-btn" class="btn btn-danger">گرتن</button>
‏        </div>
‏    </div>

‏    <div id="toast"></div>
    
‏    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
‏    <script>
‏    document.addEventListener('DOMContentLoaded', () => {
‏        // --- DOM Elements ---
‏        const el = {
‏            authView: document.getElementById('auth-view'),
‏            appContainer: document.getElementById('app-container'),
‏            loginForm: document.getElementById('login-form'),
‏            registerForm: document.getElementById('register-form'),
‏            showRegister: document.getElementById('show-register'),
‏            showLogin: document.getElementById('show-login'),
‏            logoutBtn: document.getElementById('logout-btn'),
‏            marketName: document.getElementById('market-name-display'),
‏            tabs: document.querySelectorAll('.tab-btn'),
‏            views: document.querySelectorAll('.view'),
‏            addProductForm: document.getElementById('add-product-form'),
‏            productList: document.getElementById('product-list-container'),
‏            resultContainer: document.getElementById('result-container'),
‏            startScanBtn: document.getElementById('start-scanner-btn'),
‏            stopScanBtn: document.getElementById('stop-scanner-btn'),
‏            scanStatus: document.getElementById('scan-status'),
‏            scanForAdminBtn: document.getElementById('scan-for-admin-btn'),
‏            scannerModal: document.getElementById('scanner-modal'),
‏            closeModalBtn: document.getElementById('close-modal-btn'),
‏            adminScanStatus: document.getElementById('admin-scan-status'),
‏            toast: document.getElementById('toast'),
        };

‏        // --- App State ---
‏        let state = {
‏            currentUser: null,
‏            products: [],
‏            isScannerActive: false,
‏            scannerTarget: null, // 'main' or 'admin'
        };

‏        // --- Toast Function ---
‏        const showToast = (message, type = 'success') => {
‏            el.toast.textContent = message;
‏            el.toast.className = type;
‏            el.toast.classList.add('show');
‏            setTimeout(() => el.toast.classList.remove('show'), 3000);
        };

‏        // --- Scanner Logic ---
‏        const scannerConfig = {
‏            inputStream: {
‏                name: "Live", type: "LiveStream",
‏                constraints: { width: { min: 640 }, height: { min: 480 }, facingMode: "environment" },
‏                numOfWorkers: navigator.hardwareConcurrency || 4,
            },
‏            decoder: { readers: ["ean_reader", "code_128_reader", "upc_reader"] },
‏            locate: true,
        };

‏        const startScanner = (target, statusElement) => {
‏            if (state.isScannerActive) return;
            
‏            if (target === '#interactive') {
‏                el.resultContainer.classList.remove('visible');
‏                el.resultContainer.classList.remove('not-found');
            }

‏            state.isScannerActive = true;
‏            state.scannerTarget = (target === '#interactive') ? 'main' : 'admin';
            
‏            scannerConfig.inputStream.target = document.querySelector(target);
‏            statusElement.textContent = "کامیرە دهێتە ڤەکرن...";

‏            Quagga.init(scannerConfig, (err) => {
‏                if (err) {
‏                    console.error("Quagga initialization failed:", err);
‏                    let message = "خەلەتی: نەشیا کامیرێ ڤەکەت.";
‏                    if (err.name === "NotAllowedError") {
‏                        message = "تکایە رێکێ بدە کامیرە بهێتە بکارئینان.";
                    }
‏                    statusElement.textContent = message;
‏                    state.isScannerActive = false;
‏                    return;
                }
‏                Quagga.start();
‏                statusElement.textContent = "ل بارکۆدی بگەره...";
‏                if (state.scannerTarget === 'main') {
‏                    el.startScanBtn.disabled = true;
‏                    el.stopScanBtn.disabled = false;
                }
            });
        };

‏        const stopScanner = () => {
‏            if (!state.isScannerActive && Quagga.CameraAccess.getActiveStreamLabel()) {
‏                 Quagga.stop();
‏            } else if (state.isScannerActive) {
‏                Quagga.stop();
‏                state.isScannerActive = false;
            }
            
‏            if (state.scannerTarget === 'main') {
‏                el.startScanBtn.disabled = false;
‏                el.stopScanBtn.disabled = true;
‏            } else if (state.scannerTarget === 'admin') {
‏                el.scannerModal.style.display = 'none';
            }
‏            state.scannerTarget = null;
        };

‏        Quagga.onDetected(result => {
‏            if (!state.isScannerActive) return;

‏            const code = result.codeResult.code;
‏            const currentTarget = state.scannerTarget;

‏            // Stop the camera stream and prevent further detections
‏            Quagga.stop();
‏            state.isScannerActive = false;
            
‏            if (currentTarget === 'admin') {
‏                document.getElementById('barcode').value = code;
‏                showToast('بارکۆد ب سەرکەفتی هاتە خواندن');
‏                el.scannerModal.style.display = 'none'; // Close modal after detection
‏                state.scannerTarget = null;
‏            } else if (currentTarget === 'main') {
‏                el.scanStatus.textContent = `بارکۆد هاتە دیتن: ${code}`;
‏                const product = state.products.find(p => p.barcode === code);
‏                el.resultContainer.classList.remove('not-found');
‏                if (product) {
‏                    document.getElementById('product-name-result').textContent = product.name;
‏                    document.getElementById('product-price-result').textContent = `${parseInt(product.price).toLocaleString()} IQD`;
‏                } else {
‏                    el.resultContainer.classList.add('not-found');
‏                    document.getElementById('product-name-result').textContent = 'ئەڤ بەرهەمە د سیستەمی دا نینە';
‏                    document.getElementById('product-price-result').textContent = `کۆد: ${code}`;
                }
‏                el.resultContainer.classList.add('visible');

‏                // Update control buttons
‏                el.startScanBtn.disabled = false;
‏                el.stopScanBtn.disabled = true;
‏                state.scannerTarget = null;
            }
        });
        
‏        // --- UI Logic ---
‏        const switchView = (viewId) => {
‏            if(state.isScannerActive) stopScanner();
‏            el.views.forEach(v => v.classList.remove('active'));
‏            document.getElementById(viewId).classList.add('active');
‏            el.tabs.forEach(t => t.classList.remove('active'));
‏            document.querySelector(`.tab-btn[data-view="${viewId}"]`).classList.add('active');
        };

‏        const renderAdminList = () => {
‏            if (state.products.length === 0) {
‏                el.productList.innerHTML = '<p>هێشتا چ بەرهەم نەهاتینە تۆمارکرن.</p>';
‏                return;
            }
‏            const tableHTML = `
‏                <table>
‏                    <thead><tr><th>بارکۆد</th><th>ناڤ</th><th>بها</th><th></th></tr></thead>
‏                    <tbody>
‏                        ${state.products.map(p => `
‏                            <tr>
‏                                <td>${p.barcode}</td>
‏                                <td>${p.name}</td>
‏                                <td>${parseInt(p.price).toLocaleString()} <small>IQD</small></td>
‏                                <td><button class="delete-btn" data-barcode="${p.barcode}"><i class="fa-solid fa-trash-can"></i></button></td>
‏                            </tr>`).join('')}
‏                    </tbody>
‏                </table>`;
‏            el.productList.innerHTML = tableHTML;
        };
        
‏        // --- Data & Auth Logic ---
‏        const saveProducts = () => {
‏            if (state.currentUser) localStorage.setItem(`products_${state.currentUser.email}`, JSON.stringify(state.products));
        };
        
‏        const loadUserData = () => {
‏            const userProducts = localStorage.getItem(`products_${state.currentUser.email}`);
‏            state.products = userProducts ? JSON.parse(userProducts) : [];
‏            renderAdminList();
        };
        
‏        const init = () => {
‏            const userJson = localStorage.getItem('currentUser');
‏            if (userJson) {
‏                state.currentUser = JSON.parse(userJson);
‏                el.marketName.textContent = state.currentUser.marketName;
‏                el.authView.style.display = 'none';
‏                el.appContainer.style.display = 'block';
‏                loadUserData();
‏            } else {
‏                el.authView.style.display = 'flex';
‏                el.appContainer.style.display = 'none';
            }
        };

‏        // --- Event Listeners ---
‏        el.tabs.forEach(tab => tab.addEventListener('click', () => switchView(tab.dataset.view)));
‏        el.showRegister.addEventListener('click', () => { el.loginForm.style.display = 'none'; el.registerForm.style.display = 'block'; });
‏        el.showLogin.addEventListener('click', () => { el.registerForm.style.display = 'none'; el.loginForm.style.display = 'block'; });
‏        el.startScanBtn.addEventListener('click', () => startScanner('#interactive', el.scanStatus));
‏        el.stopScanBtn.addEventListener('click', stopScanner);
‏        el.scanForAdminBtn.addEventListener('click', () => { el.scannerModal.style.display = 'flex'; startScanner('#admin-scanner-viewport', el.adminScanStatus); });
‏        el.closeModalBtn.addEventListener('click', stopScanner);
‏        el.scannerModal.addEventListener('click', (e) => { if (e.target === el.scannerModal) stopScanner(); });

‏        el.logoutBtn.addEventListener('click', () => {
‏            localStorage.removeItem('currentUser');
‏            state.currentUser = null;
‏            state.products = [];
‏            init();
        });

‏        el.registerForm.addEventListener('submit', (e) => {
‏            e.preventDefault();
‏            const marketName = document.getElementById('register-market-name').value;
‏            const email = document.getElementById('register-email').value;
‏            const password = document.getElementById('register-password').value;
‏            const users = JSON.parse(localStorage.getItem('market_users')) || {};
‏            if (users[email]) {
‏                showToast('ئەڤ ئیمێلە بەری نها هاتیە تۆمارکرن', 'danger');
‏                return;
            }
‏            users[email] = { marketName, password };
‏            localStorage.setItem('market_users', JSON.stringify(users));
‏            state.currentUser = { email, marketName };
‏            localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
‏            showToast('حسابا تە ب سەرکەفتی هاتە دروستکرن');
‏            init();
        });
        
‏        el.loginForm.addEventListener('submit', (e) => {
‏            e.preventDefault();
‏            const email = document.getElementById('login-email').value;
‏            const password = document.getElementById('login-password').value;
‏            const users = JSON.parse(localStorage.getItem('market_users')) || {};
‏            if (users[email] && users[email].password === password) {
‏                state.currentUser = { email, marketName: users[email].marketName };
‏                localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
‏                showToast('بخێرهاتی ڤە بۆ سیستەمی');
‏                init();
‏            } else {
‏                showToast('ئیمێل یان ژمارا نهێنی خەلەتە', 'danger');
            }
        });

‏        el.addProductForm.addEventListener('submit', e => {
‏            e.preventDefault();
‏            const barcode = document.getElementById('barcode').value;
‏            const name = document.getElementById('product-name').value;
‏            const price = document.getElementById('product-price').value;
‏            if (!barcode || !name || !price) return showToast('تکایە هەمی خانەیان پڕ بکە', 'danger');
‏            if (state.products.find(p => p.barcode === barcode)) return showToast('ئەڤ بارکۆدە بەری نها هاتیە تۆمارکرن!', 'danger');
            
‏            state.products.push({ barcode, name, price });
‏            saveProducts();
‏            renderAdminList();
‏            el.addProductForm.reset();
‏            showToast('بەرهەم ب سەرکەفتی هاتە زێدەکرن');
        });
        
‏        el.productList.addEventListener('click', e => {
‏            const deleteButton = e.target.closest('.delete-btn');
‏            if (deleteButton) {
‏                const barcode = deleteButton.dataset.barcode;
‏                if (confirm(`دێ پشتراستی کو دێ ڤی بەرهەمی ژێبەی؟`)) {
‏                    state.products = state.products.filter(p => p.barcode !== barcode);
‏                    saveProducts();
‏                    renderAdminList();
‏                    showToast('بەرهەم هاتە ژێبرن', 'danger');
                }
            }
        });

‏        // --- Start The App ---
‏        init();
    });
‏    </script>
‏</body>
‏</html>
